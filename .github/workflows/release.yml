name: Build Release Zip

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build plugin zip
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          SLUG="ffl-funnels-addons"

          mkdir -p build/$SLUG

          # Copy only plugin files (exclude dev/build artifacts)
          rsync -a \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='build' \
            --exclude='generate_rules.py' \
            --exclude='woobooster-rules-import.json' \
            --exclude='ffl-funnels-addons.zip' \
            --exclude='.gitignore' \
            --exclude='*.zip' \
            ./ build/$SLUG/

          cd build
          zip -r ../${SLUG}-v${VERSION}.zip $SLUG/

      - name: Upload zip to release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          SLUG="ffl-funnels-addons"

          # Remove old zip asset if it exists
          ASSET_ID=$(gh api repos/${{ github.repository }}/releases/${{ github.event.release.id }}/assets \
            --jq ".[] | select(.name == \"${SLUG}-v${VERSION}.zip\") | .id" 2>/dev/null || true)

          if [ -n "$ASSET_ID" ]; then
            gh api -X DELETE repos/${{ github.repository }}/releases/assets/$ASSET_ID
          fi

          # Upload the properly structured zip
          gh release upload "${{ github.event.release.tag_name }}" \
            "${SLUG}-v${VERSION}.zip" --clobber
